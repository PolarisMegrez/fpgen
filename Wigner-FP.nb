(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     31889,        846]
NotebookOptionsPosition[     31518,        831]
NotebookOutlinePosition[     31933,        848]
CellTagsIndexPosition[     31890,        845]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"===", "===", "===", "===", "===", "===", "===", "==="}], "="}], 
   "*)"}], 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Robust", " ", "normal"}], "-", 
    RowBox[{"order", " ", "tuple", " ", "extractor"}]}], "*)"}], 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"===", "===", "===", "===", "===", "===", "===", "==="}], "="}], 
   "*)"}], 
  RowBox[{
   RowBox[{
    RowBox[{"ClearAll", "[", 
     RowBox[{"a", ",", "aStar", ",", "dA", ",", "dAStar"}], "]"}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"NonCommutativeMultiply", ",", 
      RowBox[{"{", 
       RowBox[{"Flat", ",", "OneIdentity"}], "}"}]}], "]"}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"-", 
      RowBox[{"helper", ":", 
       RowBox[{
        RowBox[{"check", " ", "numeric", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"includes", " ", "Integer"}], ",", "Rational", ",", 
            "Real", ",", "Complex"}], ")"}], "--"}]}], "-"}]}]}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"NumericQStrict", "[", "x_", "]"}], ":=", 
     RowBox[{"NumberQ", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "recursively"}]}], " ", "extract", " ", "numeric", " ", 
      "factor", " ", "and", " ", "symbol"}], "-", 
     RowBox[{"list", " ", "from", " ", "an", " ", 
      RowBox[{"\"\<element\>\"", "--"}]}], "-"}], "*)"}], "\n", 
   RowBox[{"(*", 
    RowBox[{"returns", " ", 
     RowBox[{"{", 
      RowBox[{"numFactor", ",", 
       RowBox[{"{", 
        RowBox[{"sym1", ",", "sym2", ",", "..."}], "}"}]}], "}"}], " ", "for",
      " ", "that", " ", "element"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ClearAll", "[", "ExtractNumAndSymbols", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"ExtractNumAndSymbols", "[", "el_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"head", "=", 
         RowBox[{"Head", "[", "el", "]"}]}], "}"}], ",", 
       RowBox[{"Which", "[", 
        RowBox[{
         RowBox[{"NumericQStrict", "[", "el", "]"}], ",", 
         RowBox[{"(*", 
          RowBox[{"pure", " ", "number"}], "*)"}], 
         RowBox[{"{", 
          RowBox[{"el", ",", 
           RowBox[{"{", "}"}]}], "}"}], ",", 
         RowBox[{"head", "===", "Times"}], ",", 
         RowBox[{"Module", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"nums", ",", "nons", ",", 
             RowBox[{"num", "=", "1"}], ",", 
             RowBox[{"symList", "=", 
              RowBox[{"{", "}"}]}]}], "}"}], ",", 
           RowBox[{
            RowBox[{"nums", "=", 
             RowBox[{"Select", "[", 
              RowBox[{
               RowBox[{"List", "@@", "el"}], ",", "NumericQStrict"}], "]"}]}],
             ";", "\[IndentingNewLine]", 
            RowBox[{"nons", "=", 
             RowBox[{"Select", "[", 
              RowBox[{
               RowBox[{"List", "@@", "el"}], ",", 
               RowBox[{"Not", "@*", "NumericQStrict"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "nums", "]"}], ">", "0"}], ",", 
              RowBox[{"num", "*=", 
               RowBox[{"Times", "@@", "nums"}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
             "process", " ", "nons", " ", "parts", " ", "recursively"}], 
             "*)"}], 
            RowBox[{"Do", "[", 
             RowBox[{
              RowBox[{"Module", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"r", "=", 
                  RowBox[{"ExtractNumAndSymbols", "[", "part", "]"}]}], "}"}],
                 ",", 
                RowBox[{
                 RowBox[{"num", "*=", 
                  RowBox[{"r", "[", 
                   RowBox[{"[", "1", "]"}], "]"}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"symList", "=", 
                  RowBox[{"Join", "[", 
                   RowBox[{"symList", ",", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";"}]}], "]"}],
               ",", 
              RowBox[{"{", 
               RowBox[{"part", ",", "nons"}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"num", ",", "symList"}], "}"}]}]}], "]"}], ",", 
         RowBox[{"head", "===", "Power"}], ",", 
         RowBox[{"Module", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"base", "=", 
              RowBox[{"el", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], ",", 
             RowBox[{"exp", "=", 
              RowBox[{"el", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], ",", "r"}], "}"}], ",", 
           RowBox[{
            RowBox[{"r", "=", 
             RowBox[{"ExtractNumAndSymbols", "[", "base", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{"r", "[", 
                RowBox[{"[", "1", "]"}], "]"}], " ", "may", " ", "be", " ", 
               "numeric", " ", "factor", " ", "for", " ", "base"}], ";", 
              RowBox[{
              "raise", " ", "it", " ", "to", " ", "exp", " ", "power"}]}], 
             "*)"}], 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"r", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "^", "exp"}], ",", 
              RowBox[{"Flatten", "@", 
               RowBox[{"Table", "[", 
                RowBox[{
                 RowBox[{"r", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], ",", 
                 RowBox[{"{", "exp", "}"}]}], "]"}]}]}], "}"}]}]}], "]"}], 
         ",", 
         RowBox[{"(*", 
          RowBox[{
           RowBox[{"default", ":", 
            RowBox[{
             RowBox[{"symbol", " ", 
              RowBox[{"(", 
               RowBox[{"a", ",", "dA", ",", "..."}], ")"}], " ", "or", " ", 
              "compound", " ", "symbol"}], "-", 
             RowBox[{"treat", " ", "as", " ", "single", " ", "symbol"}]}]}], 
           ")"}], "*)"}], "True", ",", 
         RowBox[{"{", 
          RowBox[{"1", ",", 
           RowBox[{"{", "el", "}"}]}], "}"}]}], "]"}]}], "]"}]}], ";"}], "\n",
    "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "extract"}]}], " ", "from", " ", "a", " ", "full", " ", 
      "NonCommutativeMultiply", " ", "sequence", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"or", " ", "single", " ", "symbol"}], ")"}], "--"}]}], "-"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ClearAll", "[", "ExtractCoeffAndSymbolSequence2", "]"}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"ExtractCoeffAndSymbolSequence2", "[", "term_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"coeff", "=", "1"}], ",", 
         RowBox[{"t", "=", "term"}], ",", 
         RowBox[{"seq", "=", 
          RowBox[{"{", "}"}]}]}], "}"}], ",", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"factor", " ", "out", " ", "top"}], "-", 
         RowBox[{
         "level", " ", "numeric", " ", "from", " ", "a", " ", "Times", " ", 
          "at", " ", "top", " ", "level"}]}], "*)"}], 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "t", "]"}], "===", "Times"}], ",", 
          RowBox[{
           RowBox[{"Module", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"nums", ",", "nons"}], "}"}], ",", 
             RowBox[{
              RowBox[{"nums", "=", 
               RowBox[{"Select", "[", 
                RowBox[{
                 RowBox[{"List", "@@", "t"}], ",", "NumericQStrict"}], 
                "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"nons", "=", 
               RowBox[{"Select", "[", 
                RowBox[{
                 RowBox[{"List", "@@", "t"}], ",", 
                 RowBox[{"Not", "@*", "NumericQStrict"}]}], "]"}]}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Length", "[", "nums", "]"}], ">", "0"}], ",", 
                RowBox[{"coeff", "*=", 
                 RowBox[{"Times", "@@", "nums"}]}]}], "]"}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"t", "=", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"nons", "===", 
                  RowBox[{"{", "}"}]}], ",", "1", ",", 
                 RowBox[{"Times", "@@", "nons"}]}], "]"}]}], ";"}]}], "]"}], 
           ";"}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"now", " ", "t", " ", "can", " ", "be", " ", 
          RowBox[{"NonCommutativeMultiply", "[", "...", "]"}], " ", "or", " ",
           "a", " ", "single", " ", "symbol", " ", "or", " ", "1"}], "*)"}], 
        RowBox[{"t", "=", 
         RowBox[{"t", "/.", " ", 
          RowBox[{
           RowBox[{"NonCommutativeMultiply", "[", "args__", "]"}], ":>", 
           RowBox[{"Module", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"parts", "=", 
                RowBox[{"List", "[", "args", "]"}]}], ",", 
               RowBox[{"localNum", "=", "1"}], ",", 
               RowBox[{"localSyms", "=", 
                RowBox[{"{", "}"}]}]}], "}"}], ",", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"for", " ", "each", " ", "part"}], ",", 
               RowBox[{
               "extract", " ", "numeric", " ", "and", " ", "symbol", " ", 
                "contributions"}]}], "*)"}], 
             RowBox[{
              RowBox[{"Do", "[", 
               RowBox[{
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"r", "=", 
                    RowBox[{"ExtractNumAndSymbols", "[", 
                    RowBox[{"parts", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "]"}]}], "}"}], ",", 
                  RowBox[{
                   RowBox[{"localNum", "*=", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"localSyms", "=", 
                    RowBox[{"Join", "[", 
                    RowBox[{"localSyms", ",", 
                    RowBox[{"r", "[", 
                    RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";"}]}], "]"}],
                 ",", 
                RowBox[{"{", 
                 RowBox[{"k", ",", 
                  RowBox[{"Length", "[", "parts", "]"}]}], "}"}]}], "]"}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"coeff", "*=", "localNum"}], ";", "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"localSyms", "===", 
                 RowBox[{"{", "}"}]}], ",", "1", ",", 
                RowBox[{"NonCommutativeMultiply", "@@", "localSyms"}]}], 
               "]"}]}]}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
          "If", " ", "t", " ", "is", " ", "still", " ", "a", " ", "Power", 
           " ", "or", " ", "Times", " ", "etc", " ", 
           RowBox[{"(", 
            RowBox[{
            "single", " ", "remaining", " ", "symbol", " ", "maybe", " ", 
             "with", " ", "number"}], ")"}]}], ",", 
          RowBox[{"handle", " ", "it"}]}], "*)"}], 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"!", 
           RowBox[{"MatchQ", "[", 
            RowBox[{"t", ",", 
             RowBox[{"1", "|", "_NonCommutativeMultiply"}]}], "]"}]}], ",", 
          RowBox[{"Module", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"r", "=", 
              RowBox[{"ExtractNumAndSymbols", "[", "t", "]"}]}], "}"}], ",", 
            RowBox[{
             RowBox[{"coeff", "*=", 
              RowBox[{"r", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"seq", "=", 
              RowBox[{"r", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], ";"}]}], "]"}], ",", 
          RowBox[{"seq", "=", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"t", "===", "1"}], ",", 
             RowBox[{"{", "}"}], ",", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Head", "[", "t", "]"}], "===", 
                "NonCommutativeMultiply"}], ",", 
               RowBox[{"List", "@@", "t"}], ",", 
               RowBox[{"{", "}"}]}], "]"}]}], "]"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{
          "seq", " ", "is", " ", "a", " ", "list", " ", "of", " ", "symbols", 
           " ", "in", " ", "order"}], ",", 
          RowBox[{"coeff", " ", "the", " ", "numeric", " ", "factor"}]}], 
         "*)"}], 
        RowBox[{"{", 
         RowBox[{"coeff", ",", "seq"}], "}"}]}]}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "count"}]}], " ", "multiplicity", " ", "of", " ", "a", 
      " ", "given", " ", "symbol", " ", "in", " ", "sequence", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"seq", " ", "is", " ", "list"}], ")"}], "--"}]}], "-"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CountInSeq", "[", 
      RowBox[{"sym_", ",", "seq_List"}], "]"}], ":=", 
     RowBox[{"Total", "[", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"#", "===", "sym"}], ",", "1", ",", "0"}], "]"}], "&"}], 
        ",", "seq"}], "]"}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "Expand"}]}], " ", "and", " ", "convert", " ", 
      "expression", " ", "into", " ", "merged", " ", "tuples", " ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c", ",", "m", ",", "n", ",", "i", ",", "j"}], "}"}], 
       "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ClearAll", "[", "ExprToTuplesRobust", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"ExprToTuplesRobust", "[", "expr_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"expanded", ",", "terms", ",", "pairs", ",", "tuples", ",", 
         RowBox[{"assoc", "=", 
          RowBox[{"<|", "|>"}]}], ",", "key", ",", "c", ",", "seq", ",", "m", 
         ",", "n", ",", "i", ",", "j", ",", "keys", ",", "resultList"}], 
        "}"}], ",", 
       RowBox[{
        RowBox[{"expanded", "=", 
         RowBox[{"Expand", "[", "expr", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"terms", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", "expanded", "]"}], "===", "Plus"}], ",", 
           RowBox[{"List", "@@", "expanded"}], ",", 
           RowBox[{"{", "expanded", "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"pairs", "=", 
         RowBox[{"ExtractCoeffAndSymbolSequence2", "/@", "terms"}]}], ";", 
        RowBox[{"(*", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"c", ",", "seq"}], "}"}], ",", "..."}], "}"}], "*)"}], 
        RowBox[{"tuples", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"First", "[", "#", "]"}], ",", 
              RowBox[{"CountInSeq", "[", 
               RowBox[{"dA", ",", 
                RowBox[{"Last", "[", "#", "]"}]}], "]"}], ",", 
              RowBox[{"CountInSeq", "[", 
               RowBox[{"dAStar", ",", 
                RowBox[{"Last", "[", "#", "]"}]}], "]"}], ",", 
              RowBox[{"CountInSeq", "[", 
               RowBox[{"a", ",", 
                RowBox[{"Last", "[", "#", "]"}]}], "]"}], ",", 
              RowBox[{"CountInSeq", "[", 
               RowBox[{"aStar", ",", 
                RowBox[{"Last", "[", "#", "]"}]}], "]"}]}], "}"}], "&"}], ",",
            "pairs"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"merge", " ", "by", " ", "key", " ", 
          RowBox[{"{", 
           RowBox[{"m", ",", "n", ",", "i", ",", "j"}], "}"}]}], "*)"}], 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"key", "=", 
            RowBox[{"tuples", "[", 
             RowBox[{"[", 
              RowBox[{"k", ",", 
               RowBox[{"2", ";;", "5"}]}], "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"c", "=", 
            RowBox[{"tuples", "[", 
             RowBox[{"[", 
              RowBox[{"k", ",", "1"}], "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"KeyExistsQ", "[", 
              RowBox[{"assoc", ",", "key"}], "]"}], ",", 
             RowBox[{
              RowBox[{"assoc", "[", "key", "]"}], "=", 
              RowBox[{
               RowBox[{"assoc", "[", "key", "]"}], "+", "c"}]}], ",", 
             RowBox[{
              RowBox[{"assoc", "[", "key", "]"}], "=", "c"}]}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"k", ",", 
            RowBox[{"Length", "[", "tuples", "]"}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"keys", "=", 
         RowBox[{"Sort", "[", 
          RowBox[{"Keys", "[", "assoc", "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"resultList", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"assoc", "[", 
              RowBox[{"keys", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"keys", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", 
             RowBox[{"Length", "[", "keys", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"drop", " ", "zero", " ", "coefficients"}], "*)"}], 
        RowBox[{"resultList", "=", 
         RowBox[{"Select", "[", 
          RowBox[{"resultList", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"First", "[", "#", "]"}], "=!=", "0"}], "&"}]}], "]"}]}],
         ";", "\[IndentingNewLine]", "resultList"}]}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"-", "Example"}]}]}]}]}]}]}]}]}], " ", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"usage", "--"}], "--"}], "--"}], "--"}], "--"}], "--"}], 
        "--"}], "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "Suppose", " ", "you", " ", "already", " ", "have", " ", "a", " ", 
      "normal"}], "-", 
     RowBox[{
     "ordered", " ", "expression", " ", "`result`", " ", "from", " ", 
      "earlier", " ", 
      RowBox[{"steps", ".", "For"}], " ", "demonstration", " ", 
      RowBox[{"we", "'"}], "ll", " ", "compute", " ", "result", " ", "here", 
      " ", "using", " ", "the", " ", "provided", " ", "solver", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"if", " ", "you", " ", "already", " ", "have", " ", "it"}], 
         ",", 
         RowBox[{"you", " ", "can", " ", "skip", " ", "that", " ", "part"}]}],
         ")"}], "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"Minimal", " ", "normal"}], "-", 
      RowBox[{"order", " ", "solver", " ", 
       RowBox[{"(", 
        RowBox[{"from", " ", "previous"}], ")"}]}], "-", 
      RowBox[{
      "use", " ", "only", " ", "if", " ", "you", " ", "need", " ", "to", " ", 
       "get", " ", "`result`", " ", 
       RowBox[{"now", ".", "If"}], " ", "you", " ", "already", " ", "have", 
       " ", "`result`"}]}], ",", 
     RowBox[{"skip", " ", "this", " ", 
      RowBox[{"block", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ExpandNCOnce", "[", "expr_", "]"}], ":=", 
     RowBox[{"expr", "/.", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"x_", "+", "y_"}], ")"}], "**", "z_"}], ":>", 
         RowBox[{
          RowBox[{"x", "**", "z"}], "+", 
          RowBox[{"y", "**", "z"}]}]}], ",", 
        RowBox[{
         RowBox[{"x_", "**", 
          RowBox[{"(", 
           RowBox[{"y_", "+", "z_"}], ")"}]}], ":>", 
         RowBox[{
          RowBox[{"x", "**", "y"}], "+", 
          RowBox[{"x", "**", "z"}]}]}]}], "}"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"oneStepRules", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"NonCommutativeMultiply", "[", 
         RowBox[{"pre___", ",", 
          RowBox[{"s_.", " ", "a"}], ",", 
          RowBox[{"t_.", " ", "dA"}], ",", "post___"}], "]"}], ":>", 
        RowBox[{"s", "*", "t", "*", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"NonCommutativeMultiply", "[", 
            RowBox[{"pre", ",", "dA", ",", "a", ",", "post"}], "]"}], "-", 
           RowBox[{"NonCommutativeMultiply", "[", 
            RowBox[{"pre", ",", "post"}], "]"}]}], ")"}]}]}], ",", 
       RowBox[{
        RowBox[{"NonCommutativeMultiply", "[", 
         RowBox[{"pre___", ",", 
          RowBox[{"s_.", " ", "aStar"}], ",", 
          RowBox[{"t_.", " ", "dAStar"}], ",", "post___"}], "]"}], ":>", 
        RowBox[{"s", "*", "t", "*", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"NonCommutativeMultiply", "[", 
            RowBox[{"pre", ",", "dAStar", ",", "aStar", ",", "post"}], "]"}], 
           "-", 
           RowBox[{"NonCommutativeMultiply", "[", 
            RowBox[{"pre", ",", "post"}], "]"}]}], ")"}]}]}], ",", 
       RowBox[{
        RowBox[{"NonCommutativeMultiply", "[", 
         RowBox[{"pre___", ",", 
          RowBox[{"s_.", " ", "aStar"}], ",", 
          RowBox[{"t_.", " ", "dA"}], ",", "post___"}], "]"}], ":>", 
        RowBox[{"s", "*", "t", "*", 
         RowBox[{"NonCommutativeMultiply", "[", 
          RowBox[{"pre", ",", "dA", ",", "aStar", ",", "post"}], "]"}]}]}], 
       ",", 
       RowBox[{
        RowBox[{"NonCommutativeMultiply", "[", 
         RowBox[{"pre___", ",", 
          RowBox[{"s_.", " ", "a"}], ",", 
          RowBox[{"t_.", " ", "dAStar"}], ",", "post___"}], "]"}], ":>", 
        RowBox[{"s", "*", "t", "*", 
         RowBox[{"NonCommutativeMultiply", "[", 
          RowBox[{"pre", ",", "dAStar", ",", "a", ",", "post"}], "]"}]}]}]}], 
      "}"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"OnePassOrder", "[", "expr_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"exp1", ",", "exp2"}], "}"}], ",", 
       RowBox[{
        RowBox[{"exp1", "=", 
         RowBox[{"ExpandNCOnce", "[", "expr", "]"}]}], ";", 
        RowBox[{"exp2", "=", 
         RowBox[{"exp1", "//.", "oneStepRules"}]}], ";", "exp2"}]}], "]"}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"NormalOrderSolve", "[", 
      RowBox[{"expr_", ",", 
       RowBox[{"maxSteps_", ":", "80"}]}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"cur", "=", "expr"}], ",", "next", ",", 
         RowBox[{"history", "=", 
          RowBox[{"{", "}"}]}], ",", 
         RowBox[{"i", "=", "0"}]}], "}"}], ",", 
       RowBox[{
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{"i", "<", "maxSteps"}], ",", 
          RowBox[{
           RowBox[{"i", "++"}], ";", "\[IndentingNewLine]", 
           RowBox[{"next", "=", 
            RowBox[{
             RowBox[{"OnePassOrder", "[", "cur", "]"}], "//", "Expand"}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"next", "===", "cur"}], ",", 
             RowBox[{"Break", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"MemberQ", "[", 
              RowBox[{"history", ",", "next"}], "]"}], ",", 
             RowBox[{
              RowBox[{"Message", "[", 
               RowBox[{
                RowBox[{"NormalOrderSolve", "::", "loop"}], ",", "i"}], "]"}],
               ";", 
              RowBox[{"Break", "[", "]"}]}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"history", ",", "cur"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"cur", "=", "next"}], ";"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"cur", "=", 
         RowBox[{
          RowBox[{"cur", "/.", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"NonCommutativeMultiply", "[", "]"}], "->", "1"}], ",", 
             RowBox[{
              RowBox[{"NonCommutativeMultiply", "[", "x_", "]"}], ":>", 
              "x"}]}], "}"}]}], "//", "Expand"}]}], ";", 
        "\[IndentingNewLine]", "cur"}]}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"NormalOrderSolve", "::", "loop"}], "=", 
     "\"\<Iteration appears to be oscillating at step `1`. Returning current \
result.\>\""}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "define", " ", "expr", " ", "and", " ", "compute", " ", "result", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
       "if", " ", "you", " ", "already", " ", "have", " ", "`result`"}], ",", 
       RowBox[{"replace", " ", "below"}]}], ")"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"expr", "=", 
     RowBox[{
      RowBox[{"2", "**", 
       RowBox[{"(", 
        RowBox[{"a", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"a", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"aStar", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"aStar", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}]}], "-", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"aStar", "-", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"aStar", "-", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"a", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"a", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}]}], "-", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"a", "-", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"a", "-", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dAStar"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"aStar", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}], "**", 
       RowBox[{"(", 
        RowBox[{"aStar", "+", 
         RowBox[{
          RowBox[{"1", "/", "2"}], " ", "dA"}]}], ")"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"result", "=", 
     RowBox[{"NormalOrderSolve", "[", 
      RowBox[{"expr", ",", "80"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{
    "Print", "[", "\"\<Normal-ordered expression (expanded):\>\"", "]"}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", "result", "]"}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"tuplesList", "=", 
     RowBox[{"ExprToTuplesRobust", "[", "result", "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Print", "[", "\"\<\\nTuples {c,m,n,i,j} (merged):\>\"", "]"}], 
    ";"}], "\n", 
   RowBox[{"TableForm", "[", "tuplesList", "]"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", 
    RowBox[{
    "Reconstruct", " ", "readable", " ", "expression", " ", "from", " ", 
     "tuples", " ", 
     RowBox[{"(", 
      RowBox[{"sanity", " ", "check"}], ")"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"reconstructed", "=", 
     RowBox[{"Plus", "@@", 
      RowBox[{"(", 
       RowBox[{"tuplesList", "/.", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"c_", ",", "m_", ",", "n_", ",", "i_", ",", "j_"}], "}"}], ":>", 
         RowBox[{"c", "*", 
          RowBox[{"dA", "^", "m"}], "*", 
          RowBox[{"dAStar", "^", "n"}], "*", 
          RowBox[{"a", "^", "i"}], "*", 
          RowBox[{"aStar", "^", "j"}]}]}]}], ")"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
    "Print", "[", "\"\<\\nReconstructed expression from tuples:\>\"", "]"}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{"reconstructed", "//", "Expand"}], "]"}], ";"}], 
   "\n"}]}]], "Input",
 CellChangeTimes->{{3.9699378547295012`*^9, 3.9699378547310667`*^9}, {
   3.9699381980541344`*^9, 3.9699383232542515`*^9}, {3.9699429944263906`*^9, 
   3.9699430615124187`*^9}, {3.969943107388392*^9, 3.9699431086508384`*^9}, 
   3.9699431575641556`*^9, 3.969948918875334*^9, {3.9699694620763845`*^9, 
   3.969969475292102*^9}, {3.9699695935217466`*^9, 3.9699695948845053`*^9}, {
   3.969969939155012*^9, 3.9699699455860577`*^9}, {3.969970077306386*^9, 
   3.969970093999069*^9}, {3.9699701307971787`*^9, 3.9699701372662144`*^9}, {
   3.969970173522443*^9, 3.969970179867982*^9}, {3.9699711272082872`*^9, 
   3.9699712285668755`*^9}},
 CellLabel->
  "In[176]:=",ExpressionUUID->"23b8da6e-dbad-477f-8594-a1843723021e"]
},
WindowSize->{571, 418.5},
WindowMargins->{{123, Automatic}, {12, Automatic}},
FrontEndVersion->"13.3 for Microsoft Windows (64-bit) (2023\:5e747\:670824\
\:65e5)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"0e8d98be-7837-404b-a88d-db783549f3a5"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 30956, 809, 4423, "Input",ExpressionUUID->"23b8da6e-dbad-477f-8594-a1843723021e"]
}
]
*)

